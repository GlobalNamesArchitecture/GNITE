From 7253b8a2b73069823581f94d7fa1e2eee57f6ed4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Harold=20Gim=C3=A9nez?= <hgimenez@thoughtbot.com>
Date: Tue, 21 Sep 2010 13:18:01 -0400
Subject: [PATCH] WIP - getting classification revisions working

---
 app/models/gnaclr_classification.rb                |    8 +++
 app/models/gnaclr_classification_revision.rb       |   14 +++++-
 features/import_from_gnaclr.feature                |   16 +++++--
 features/step_definitions/gnaclr_steps.rb          |    7 +--
 features/support/fake_gnaclr.rb                    |    5 +-
 spec/models/gnaclr_classification_revision_spec.rb |    8 ++-
 spec/models/gnaclr_classification_spec.rb          |   52 ++++++++++++++++++++
 7 files changed, 95 insertions(+), 15 deletions(-)

diff --git a/app/models/gnaclr_classification.rb b/app/models/gnaclr_classification.rb
index 5adb28c..3bb2180 100644
--- a/app/models/gnaclr_classification.rb
+++ b/app/models/gnaclr_classification.rb
@@ -46,6 +46,14 @@ class GnaclrClassification
     uuid
   end
 
+  def add_revision_from_attributes(revision_attributes)
+    (self.revisions ||= []) << GnaclrClassificationRevision.new(revision_attributes)
+  end
+
+  def revision_count
+    self.revisions.count
+  end
+
   private
 
   def self.from_xml(xml)
diff --git a/app/models/gnaclr_classification_revision.rb b/app/models/gnaclr_classification_revision.rb
index a75564c..cc0f9e4 100644
--- a/app/models/gnaclr_classification_revision.rb
+++ b/app/models/gnaclr_classification_revision.rb
@@ -1,11 +1,21 @@
 class GnaclrClassificationRevision
-  attr_accessor :url, :file_name, :tree_id
+  attr_accessor :url, :file_name, :tree_id, :message, :number
 
   def initialize(attributes)
     attributes.symbolize_keys!
 
-    [:url, :file_name, :tree_id].each do |key|
+    [:url, :file_name, :tree_id, :message, :number].each do |key|
       self.send(:"#{key}=", attributes[key])
     end
   end
+
+  def to_hash
+    {
+      :number    => number,
+      :url       => url,
+      :file_name => file_name,
+      :tree_id   => tree_id,
+      :message   => message
+    }
+  end
 end
diff --git a/features/import_from_gnaclr.feature b/features/import_from_gnaclr.feature
index 95d235d..bc764ff 100644
--- a/features/import_from_gnaclr.feature
+++ b/features/import_from_gnaclr.feature
@@ -1,18 +1,19 @@
 Feature: Importing trees from GNACLR
-
-  @javascript
-  Scenario: Importing the sample NCBI tree
+  Background:
     Given I am signed up and confirmed as "email@person.com/password"
     And "email@person.com" has created an existing master tree titled "Moose tree" with:
       | Bullwinkle |
-    And I sign in as "email@person.com/password"
     And GNACLR contains the following classifications:
       | title          | author_list                           | description             | updated             | uuid | file_url             |
       | NCBI           | Dmitry Mozzherin <dmitry@example.com> | NCBI classification     | 2010-07-15 16:49:40 | 1    | cyphophthalmi.tar.gz |
+    And I sign in as "email@person.com/password"
     Then I should be on the master tree index page
     When I follow "Moose tree"
     And I follow "Browse GNACLR Database"
     And I follow "NCBI"
+
+  @javascript
+  Scenario: Importing the sample NCBI tree
     And I press "Import"
     Then I should see a spinner
     When delayed jobs are run
@@ -21,3 +22,10 @@ Feature: Importing trees from GNACLR
     And the "NCBI" tab should be active
     And I should see a node "Cyphophthalmi incertae sedis" at the root level in my reference tree "NCBI"
     And I should see a node "Opiliones" at the root level in my reference tree "NCBI"
+
+  @javascript
+  Scenario: Importing an older revision of the sample NCBI tree
+    Given the GNACLR classification "NCBI" has the following revisions:
+      | number | message                          | file_name                            |
+      | 2      | this is the really best revision | 853437dc-6d9f-ba30-5ae006fccae3.gzip |
+      | 1      | this is the best revision        | 853437dc-4ab5-ba30-5ae006fccae2.gzip |
diff --git a/features/step_definitions/gnaclr_steps.rb b/features/step_definitions/gnaclr_steps.rb
index 48cadaa..df92139 100644
--- a/features/step_definitions/gnaclr_steps.rb
+++ b/features/step_definitions/gnaclr_steps.rb
@@ -5,8 +5,7 @@ Given /^GNACLR contains the following classifications:$/ do |table|
 end
 
 Given /^the GNACLR classification "([^"]*)" has the following revisions:$/ do |classification_title, table|
-  pending
-  # table.hashes.each do |hash|
-  #   FakeGnaclr::Store.insert_revision_with_message_for_classification_title(hash['message'], classification_title)
-  # end
+  table.hashes.each do |revision_attributes|
+    FakeGnaclr::Store.insert_revision_for_classification_title(revision_attributes, classification_title)
+  end
 end
diff --git a/features/support/fake_gnaclr.rb b/features/support/fake_gnaclr.rb
index 3ea6531..f5b0033 100644
--- a/features/support/fake_gnaclr.rb
+++ b/features/support/fake_gnaclr.rb
@@ -36,10 +36,9 @@ module FakeGnaclr
       end
     end
 
-    def self.insert_revision_with_message_for_classification_title(message, classification_title)
+    def self.insert_revision_with_message_for_classification_title(revision_attributes, classification_title)
       classification = @@classifications.detect { |c| c.title == classification_title }
-      classification.revisions ||= []
-      classification.revisions << message
+      classification.add_revision_from_attributes(revision_attributes)
     end
 
     private
diff --git a/spec/models/gnaclr_classification_revision_spec.rb b/spec/models/gnaclr_classification_revision_spec.rb
index 434d120..030884c 100644
--- a/spec/models/gnaclr_classification_revision_spec.rb
+++ b/spec/models/gnaclr_classification_revision_spec.rb
@@ -5,15 +5,19 @@ describe GnaclrClassificationRevision, 'valid' do
     {
       'url'       => 'http://gnaclr.globalnames.org/classification_file/9/64ff3af4018c3e8fd27f5590387fbdc65289e682',
       'file_name' => '853437dc-6d9f-4ab5-ba30-5ae006fccae2.gzip',
-      'tree_id'   => '64ff3af4018c3e8fd27f5590387fbdc65289e682'
+      'tree_id'   => '64ff3af4018c3e8fd27f5590387fbdc65289e682',
+      'message'   => 'My revision message',
+      'number'    => '1'
     }
   end
 
-  it 'has an url, a file_name, a tree_id and a message' do
+  it 'has an url, a file_name, a tree_id, a message and a number' do
     revision                  = GnaclrClassificationRevision.new(attributes)
     revision.url.should       == 'http://gnaclr.globalnames.org/classification_file/9/64ff3af4018c3e8fd27f5590387fbdc65289e682'
     revision.file_name.should == '853437dc-6d9f-4ab5-ba30-5ae006fccae2.gzip'
     revision.tree_id.should   == '64ff3af4018c3e8fd27f5590387fbdc65289e682'
+    revision.message.should   == 'My revision message'
+    revision.number.should    == '1'
   end
 
 end
diff --git a/spec/models/gnaclr_classification_spec.rb b/spec/models/gnaclr_classification_spec.rb
index 4f968c4..0bd956e 100644
--- a/spec/models/gnaclr_classification_spec.rb
+++ b/spec/models/gnaclr_classification_spec.rb
@@ -94,3 +94,55 @@ describe GnaclrClassification, "attributes" do
     GnaclrClassification.new.revisions.should == []
   end
 end
+
+describe GnaclrClassification, 'adding a revision' do
+  subject do
+    GnaclrClassification.new(
+      :title       => "Title",
+      :authors     => ["Author 1", "Author 2"],
+      :description => "Description",
+      :uuid        => "abcdef-ghij-klmnop",
+      :file_url    => 'example.tar.gz'
+      )
+  end
+
+  let(:revision_attributes) do
+    { :url       => 'http://gnaclr.globalnames.org',
+      :file_name => 'example.tgz',
+      :tree_id   => 'some id',
+      :message   => 'revision message' }
+  end
+
+  it 'accepts a revision when it has no revisions' do
+    subject.add_revision_from_attributes(revision_attributes)
+    subject.revisions.count.should == 1
+    subject.revisions.first.to_hash.should == revision_attributes
+  end
+
+  it 'accepts a revision when it already has revisions' do
+    subject.add_revision_from_attributes(revision_attributes)
+    subject.add_revision_from_attributes(revision_attributes)
+    subject.revisions.count.should == 2
+  end
+end
+
+describe GnaclrClassification, 'with two revisions' do
+  subject do
+    GnaclrClassification.new(
+      :title       => "Title",
+      :authors     => ["Author 1", "Author 2"],
+      :description => "Description",
+      :uuid        => "abcdef-ghij-klmnop",
+      :file_url    => 'example.tar.gz'
+      )
+  end
+
+  before do
+    2.times { subject.add_revision_from_attributes({}) }
+  end
+
+  it 'returns 2 for revision_count' do
+    subject.revision_count.should == 2
+  end
+
+end
-- 
1.7.1+GitX

